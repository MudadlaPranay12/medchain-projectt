<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedChain | Blockchain Medicine Verification</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        /* ========== CSS VARIABLES ========== */
        :root {
            --dark-bg: #0a192f;
            --container-bg: #112240;
            --accent: #64ffda;
            --accent-glow: rgba(100, 255, 218, 0.3);
            --light-text: #e6f1ff;
            --muted-text: #8892b0;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --purple: #8a2be2;
            --cyan: #06b6d4;
            --border-color: rgba(100, 255, 218, 0.1);
            --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.4);
            --shadow-accent: 0 0 30px rgba(100, 255, 218, 0.3);
            --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --glass-bg: rgba(17, 34, 64, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        /* ========== RESET & BASE ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            overflow-x: hidden;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--dark-bg);
            color: var(--light-text);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            line-height: 1.6;
        }

        /* ========== ANIMATIONS ========== */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes glow {

            0%,
            100% {
                box-shadow: 0 0 20px var(--accent-glow);
            }

            50% {
                box-shadow: 0 0 40px var(--accent-glow);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes borderGlow {

            0%,
            100% {
                border-color: var(--accent);
            }

            25% {
                border-color: var(--purple);
            }

            50% {
                border-color: var(--info);
            }

            75% {
                border-color: var(--cyan);
            }
        }

        /* ========== BACKGROUND EFFECTS ========== */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -3;
            background:
                radial-gradient(circle at 10% 20%, rgba(100, 255, 218, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(138, 43, 226, 0.03) 0%, transparent 20%),
                radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.02) 0%, transparent 30%);
        }

        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(rgba(100, 255, 218, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(100, 255, 218, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -2;
            mask-image: radial-gradient(circle at 50% 50%, black 40%, transparent 70%);
            animation: gridMove 20s linear infinite;
        }

        @keyframes gridMove {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(50px, 50px);
            }
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: var(--accent);
            border-radius: 50%;
            animation: particleFloat 20s infinite linear;
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(100vh) translateX(0) rotate(0deg);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                transform: translateY(-100vh) translateX(100px) rotate(360deg);
                opacity: 0;
            }
        }

        /* ========== LOGIN MODAL ========== */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 25, 47, 0.98);
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(15px);
            padding: 20px;
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
        }

        .login-content {
            background: linear-gradient(135deg, var(--container-bg), rgba(17, 34, 64, 0.9));
            border-radius: 25px;
            padding: 50px;
            width: 95%;
            max-width: 500px;
            border: 2px solid var(--accent);
            position: relative;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            overflow: hidden;
        }

        .login-content::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg,
                    var(--accent),
                    var(--purple),
                    var(--info),
                    var(--accent));
            z-index: -1;
            border-radius: 27px;
            animation: borderGlow 3s linear infinite;
            background-size: 400% 400%;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo i {
            font-size: 4rem;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }

        .login-logo h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .login-logo p {
            color: var(--muted-text);
            font-size: 0.95rem;
        }

        .login-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: rgba(10, 25, 47, 0.6);
            padding: 10px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
        }

        .login-tab {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            color: var(--muted-text);
            font-weight: 600;
            cursor: pointer;
            border-radius: 10px;
            transition: var(--transition);
            text-align: center;
        }

        .login-tab.active {
            background: linear-gradient(135deg, var(--accent), #0d9488);
            color: var(--dark-bg);
            box-shadow: 0 5px 15px rgba(100, 255, 218, 0.3);
        }

        .login-form {
            margin-top: 20px;
            display: none;
        }

        .login-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--accent);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 15px 18px;
            border-radius: 12px;
            background: rgba(10, 25, 47, 0.6);
            border: 2px solid var(--border-color);
            color: var(--light-text);
            font-size: 0.95rem;
            outline: none;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(100, 255, 218, 0.3);
        }

        .form-group .password-container {
            position: relative;
        }

        .form-group .password-container input {
            padding-right: 45px;
        }

        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--muted-text);
            cursor: pointer;
            font-size: 1rem;
            transition: var(--transition);
        }

        .toggle-password:hover {
            color: var(--accent);
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .remember-forgot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 0.85rem;
        }

        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--muted-text);
            cursor: pointer;
        }

        .remember-me input {
            width: 16px;
            height: 16px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .forgot-password {
            color: var(--accent);
            text-decoration: none;
            transition: var(--transition);
        }

        .forgot-password:hover {
            text-decoration: underline;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent), #0d9488);
            color: var(--dark-bg);
            border: none;
            border-radius: 15px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 10px 30px rgba(100, 255, 218, 0.3);
        }

        .login-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(100, 255, 218, 0.4);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .login-switch {
            text-align: center;
            color: var(--muted-text);
            font-size: 0.9rem;
        }

        .login-switch a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            margin-left: 5px;
        }

        .login-switch a:hover {
            text-decoration: underline;
        }

        .login-error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 20px;
            color: var(--danger);
            display: none;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            animation: shake 0.5s ease;
        }

        .login-error.show {
            display: flex;
        }

        .login-success {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 20px;
            color: var(--success);
            display: none;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .login-success.show {
            display: flex;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-5px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(5px);
            }
        }

        /* ========== USER MENU ========== */
        .user-menu {
            position: fixed;
            top: 25px;
            left: 25px;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 15px;
            backdrop-filter: blur(20px);
            background: linear-gradient(135deg, rgba(17, 34, 64, 0.8), rgba(10, 25, 47, 0.6));
            padding: 12px 20px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .user-menu.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--dark-bg);
            font-size: 1.2rem;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: var(--light-text);
            font-size: 0.95rem;
        }

        .user-role {
            font-size: 0.8rem;
            color: var(--accent);
            margin-top: 2px;
        }

        .logout-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: scale(1.1);
        }

        /* ========== GLASS EFFECT UTILITIES ========== */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
        }

        .glass-dark {
            background: rgba(10, 25, 47, 0.8);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(100, 255, 218, 0.1);
        }

        /* ========== FLOATING BUTTONS ========== */
        .help-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            background: linear-gradient(135deg, var(--container-bg), rgba(17, 34, 64, 0.9));
            color: var(--accent);
            padding: 16px 28px;
            border-radius: 15px;
            border: 2px solid var(--accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 600;
            font-size: 1rem;
            backdrop-filter: blur(15px);
            transition: var(--transition);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            animation: float 3s ease-in-out infinite;
        }

        .help-btn:hover {
            background: rgba(100, 255, 218, 0.15);
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 20px 45px rgba(100, 255, 218, 0.2);
            animation: none;
        }

        .ai-assistant-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 1000;
            background: linear-gradient(135deg, var(--purple), var(--info));
            color: white;
            padding: 16px 28px;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 600;
            font-size: 1rem;
            backdrop-filter: blur(15px);
            transition: var(--transition);
            box-shadow: 0 15px 35px rgba(138, 43, 226, 0.3);
            animation: float 3s ease-in-out infinite 0.5s;
        }

        .ai-assistant-btn:hover {
            background: linear-gradient(135deg, var(--info), var(--purple));
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 20px 45px rgba(138, 43, 226, 0.4);
            animation: none;
        }

        /* ========== MODAL OVERLAY ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 25, 47, 0.95);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(20px);
            padding: 20px;
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
        }

        /* ========== HELP MODAL ========== */
        .help-modal {
            background: linear-gradient(135deg, var(--container-bg), rgba(17, 34, 64, 0.95));
            border-radius: 30px;
            padding: 60px;
            width: 95%;
            max-width: 900px;
            border: 2px solid var(--accent);
            position: relative;
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(30px);
            animation: slideUp 0.4s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        .help-modal::-webkit-scrollbar {
            width: 8px;
        }

        .help-modal::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .help-modal::-webkit-scrollbar-thumb {
            background: linear-gradient(var(--accent), var(--cyan));
            border-radius: 4px;
        }

        .help-modal::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--accent), var(--purple), var(--info), var(--accent));
            z-index: -1;
            border-radius: 32px;
            animation: borderGlow 3s linear infinite;
            background-size: 400% 400%;
        }

        .help-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .help-header h2 {
            font-size: 2.8rem;
            background: linear-gradient(135deg, var(--accent), var(--cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .help-header p {
            color: var(--muted-text);
            font-size: 1.2rem;
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.8;
        }

        .steps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 30px;
            margin-bottom: 50px;
        }

        .step-card {
            background: rgba(100, 255, 218, 0.08);
            border-radius: 20px;
            padding: 35px 25px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .step-card:hover {
            transform: translateY(-8px);
            background: rgba(100, 255, 218, 0.12);
            border-color: var(--accent);
            box-shadow: 0 20px 50px rgba(100, 255, 218, 0.15);
        }

        .step-number {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--accent), var(--cyan));
            color: var(--dark-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.5rem;
            margin: 0 auto 25px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 15px 30px rgba(100, 255, 218, 0.3);
            transition: var(--transition);
        }

        .step-card:hover .step-number {
            transform: rotate(360deg) scale(1.1);
        }

        .step-card h3 {
            color: var(--light-text);
            margin-bottom: 15px;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .step-card p {
            color: var(--muted-text);
            font-size: 0.95rem;
            line-height: 1.7;
        }

        .features-section {
            background: rgba(100, 255, 218, 0.05);
            border-radius: 25px;
            padding: 40px;
            margin: 40px 0;
            border: 1px solid var(--border-color);
        }

        .features-section h3 {
            color: var(--accent);
            margin-bottom: 30px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            transition: var(--transition);
        }

        .feature-item:hover {
            background: rgba(100, 255, 218, 0.08);
            transform: translateX(8px);
        }

        .feature-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent), rgba(100, 255, 218, 0.2));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
            font-size: 1.2rem;
        }

        .feature-text {
            flex: 1;
        }

        .feature-text strong {
            display: block;
            color: var(--light-text);
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .feature-text small {
            color: var(--muted-text);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .close-help {
            padding: 18px 50px;
            background: linear-gradient(135deg, var(--accent), var(--cyan));
            color: var(--dark-bg);
            border: none;
            border-radius: 15px;
            font-weight: 700;
            cursor: pointer;
            display: block;
            margin: 40px auto 0;
            transition: var(--transition);
            font-size: 1.1rem;
            letter-spacing: 0.5px;
            box-shadow: 0 15px 35px rgba(100, 255, 218, 0.3);
            position: relative;
            overflow: hidden;
        }

        .close-help:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 25px 50px rgba(100, 255, 218, 0.4);
        }

        /* ========== AI ASSISTANT MODAL ========== */
        .ai-modal {
            background: linear-gradient(135deg, var(--container-bg), rgba(17, 34, 64, 0.95));
            border-radius: 30px;
            padding: 50px;
            width: 95%;
            max-width: 800px;
            border: 2px solid var(--purple);
            position: relative;
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(30px);
            animation: slideUp 0.4s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        .ai-modal::-webkit-scrollbar {
            width: 8px;
        }

        .ai-modal::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .ai-modal::-webkit-scrollbar-thumb {
            background: linear-gradient(var(--purple), var(--info));
            border-radius: 4px;
        }

        .ai-modal::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--purple), var(--info), var(--accent));
            z-index: -1;
            border-radius: 32px;
            animation: borderGlow 3s linear infinite;
            background-size: 400% 400%;
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 25px;
            margin-bottom: 35px;
        }

        .ai-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--purple), var(--info));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            box-shadow: 0 20px 40px rgba(138, 43, 226, 0.3);
            animation: float 3s ease-in-out infinite;
        }

        .ai-header h2 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--purple), var(--info));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .ai-chat-container {
            height: 350px;
            overflow-y: auto;
            margin-bottom: 30px;
            padding-right: 15px;
        }

        .ai-chat-container::-webkit-scrollbar {
            width: 8px;
        }

        .ai-chat-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .ai-chat-container::-webkit-scrollbar-thumb {
            background: linear-gradient(var(--purple), var(--info));
            border-radius: 4px;
        }

        .chat-message {
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 20px;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }

        .chat-message.ai {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.15), rgba(59, 130, 246, 0.1));
            border-left: 4px solid var(--purple);
            margin-right: auto;
        }

        .chat-message.user {
            background: linear-gradient(135deg, rgba(100, 255, 218, 0.15), rgba(6, 182, 212, 0.1));
            border-right: 4px solid var(--accent);
            margin-left: auto;
            text-align: right;
        }

        .chat-message .sender {
            display: block;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .chat-message.ai .sender {
            color: var(--purple);
        }

        .chat-message.user .sender {
            color: var(--accent);
        }

        .chat-message .content {
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .quick-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 25px 0;
        }

        .quick-question {
            padding: 12px 24px;
            background: rgba(138, 43, 226, 0.1);
            color: var(--accent);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .quick-question:hover {
            background: rgba(138, 43, 226, 0.2);
            transform: translateY(-2px);
        }

        .ai-input-area {
            display: flex;
            gap: 20px;
            margin-top: 25px;
        }

        .ai-input {
            flex: 1;
            padding: 18px 25px;
            border-radius: 15px;
            background: rgba(10, 25, 47, 0.7);
            border: 2px solid var(--border-color);
            color: var(--light-text);
            font-size: 1rem;
            outline: none;
            transition: var(--transition);
        }

        .ai-input:focus {
            border-color: var(--purple);
            box-shadow: 0 0 25px rgba(138, 43, 226, 0.3);
        }

        .ai-send-btn {
            padding: 18px 35px;
            background: linear-gradient(135deg, var(--purple), var(--info));
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 700;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 120px;
            justify-content: center;
        }

        .ai-send-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(138, 43, 226, 0.4);
        }

        .close-ai {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, var(--purple), var(--info));
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 15px 35px rgba(138, 43, 226, 0.3);
        }

        .close-ai:hover {
            transform: rotate(90deg) scale(1.1);
        }

        /* ========== SCANNER MODAL ========== */
        .scanner-modal {
            background: linear-gradient(135deg, var(--container-bg), rgba(17, 34, 64, 0.95));
            border-radius: 30px;
            padding: 60px;
            width: 95%;
            max-width: 1200px;
            border: 2px solid var(--accent);
            position: relative;
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(30px);
            animation: slideUp 0.4s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        .scanner-modal::-webkit-scrollbar {
            width: 8px;
        }

        .scanner-modal::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .scanner-modal::-webkit-scrollbar-thumb {
            background: linear-gradient(var(--accent), var(--cyan));
            border-radius: 4px;
        }

        .scanner-modal::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--accent), var(--purple), var(--info), var(--accent));
            z-index: -1;
            border-radius: 32px;
            animation: borderGlow 3s linear infinite;
            background-size: 400% 400%;
        }

        .scanner-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .scanner-title {
            font-size: 3rem;
            background: linear-gradient(135deg, var(--accent), var(--cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            font-weight: 900;
        }

        .scanner-subtitle {
            color: var(--muted-text);
            font-size: 1.3rem;
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.8;
        }

        .scanner-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 50px;
            margin-bottom: 50px;
        }

        @media (max-width: 1024px) {
            .scanner-content {
                grid-template-columns: 1fr;
            }
        }

        .scanner-visual {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .qr-scanner-area {
            width: 100%;
            height: 400px;
            background: linear-gradient(135deg, var(--dark-bg), rgba(10, 25, 47, 0.9));
            border-radius: 25px;
            border: 3px dashed var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
            animation: glow 2s infinite alternate;
        }

        .scanner-frame {
            width: 300px;
            height: 300px;
            border: 4px solid var(--accent);
            border-radius: 15px;
            position: relative;
            animation: pulse 2s infinite;
        }

        .scanner-frame::before,
        .scanner-frame::after {
            content: '';
            position: absolute;
            width: 50px;
            height: 50px;
            border: 4px solid var(--accent);
        }

        .scanner-frame::before {
            top: 0;
            left: 0;
            border-right: none;
            border-bottom: none;
        }

        .scanner-frame::after {
            bottom: 0;
            right: 0;
            border-left: none;
            border-top: none;
        }

        .camera-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .camera-btn {
            padding: 15px 30px;
            border-radius: 15px;
            border: 2px solid var(--accent);
            background: rgba(100, 255, 218, 0.1);
            color: var(--accent);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: var(--transition);
            min-width: 180px;
            justify-content: center;
        }

        .camera-btn:hover {
            background: rgba(100, 255, 218, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(100, 255, 218, 0.2);
        }

        .demo-section {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .demo-section h3 {
            color: var(--accent);
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .demo-section p {
            color: var(--muted-text);
            font-size: 1rem;
            line-height: 1.6;
        }

        .demo-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .demo-btn {
            padding: 25px;
            border-radius: 20px;
            border: 2px solid var(--accent);
            background: rgba(100, 255, 218, 0.1);
            color: var(--accent);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: var(--transition);
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        .demo-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: 0.5s;
        }

        .demo-btn:hover::before {
            left: 100%;
        }

        .demo-btn:hover {
            background: rgba(100, 255, 218, 0.2);
            transform: translateX(10px);
            box-shadow: 0 20px 40px rgba(100, 255, 218, 0.15);
        }

        .demo-btn .btn-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .demo-btn.verified {
            border-color: var(--success);
            color: var(--success);
            background: rgba(16, 185, 129, 0.15);
        }

        .demo-btn.warning {
            border-color: var(--warning);
            color: var(--warning);
            background: rgba(245, 158, 11, 0.15);
        }

        .demo-btn.danger {
            border-color: var(--danger);
            color: var(--danger);
            background: rgba(239, 68, 68, 0.15);
        }

        .demo-btn.info {
            border-color: var(--info);
            color: var(--info);
            background: rgba(59, 130, 246, 0.15);
        }

        .demo-checklist {
            background: rgba(100, 255, 218, 0.05);
            border-radius: 25px;
            padding: 35px;
            border: 1px solid var(--border-color);
            margin-top: 30px;
        }

        .demo-checklist h4 {
            color: var(--accent);
            margin-bottom: 25px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .checklist-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            transition: var(--transition);
        }

        .checklist-item:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(5px);
        }

        .checklist-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .checklist-item label {
            cursor: pointer;
            font-size: 1rem;
            color: var(--muted-text);
        }

        .close-scanner {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--accent), var(--cyan));
            color: var(--dark-bg);
            border: none;
            border-radius: 50%;
            font-size: 28px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 15px 35px rgba(100, 255, 218, 0.3);
        }

        .close-scanner:hover {
            transform: rotate(90deg) scale(1.1);
        }

        /* ========== LANDING PAGE ========== */
        .landing-screen {
            min-height: 100vh;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            position: relative;
        }

        .landing-screen.active {
            display: flex;
        }

        .logo-container {
            margin-bottom: 60px;
            position: relative;
        }

        .logo-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
            filter: blur(40px);
            opacity: 0.5;
            z-index: 0;
        }

        .main-logo {
            width: 200px;
            height: 200px;
            background: linear-gradient(135deg, var(--accent), var(--cyan), var(--purple));
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 40px;
            box-shadow: 0 30px 60px rgba(100, 255, 218, 0.4);
            position: relative;
            z-index: 1;
            transition: var(--transition);
        }

        .main-logo:hover {
            transform: rotate(5deg) scale(1.05);
            box-shadow: 0 40px 80px rgba(100, 255, 218, 0.5);
        }

        .main-logo i {
            font-size: 80px;
            color: var(--dark-bg);
        }

        .app-title {
            font-size: 4.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent), var(--cyan), var(--purple), var(--info));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            line-height: 1.2;
            text-shadow: 0 10px 30px rgba(100, 255, 218, 0.2);
            letter-spacing: 1px;
        }

        .app-title::after {
            content: '';
            display: block;
            width: 200px;
            height: 5px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            margin: 20px auto;
            border-radius: 5px;
        }

        .app-tagline {
            font-size: 1.5rem;
            color: var(--muted-text);
            margin-bottom: 50px;
            max-width: 800px;
            line-height: 1.8;
            padding: 30px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        }

        .status-legend {
            background: var(--glass-bg);
            border-radius: 25px;
            padding: 40px;
            margin: 40px auto;
            max-width: 600px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        .status-legend h4 {
            color: var(--accent);
            margin-bottom: 30px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
        }

        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            transition: var(--transition);
            border: 1px solid transparent;
        }

        .legend-item:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: var(--border-color);
            transform: translateX(8px);
        }

        .legend-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
            position: relative;
        }

        .legend-dot::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .legend-dot.verified {
            background: var(--success);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
        }

        .legend-dot.warning {
            background: var(--warning);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.4);
        }

        .legend-dot.danger {
            background: var(--danger);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
        }

        .legend-text {
            flex: 1;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .scan-cta {
            margin: 50px 0;
            text-align: center;
        }

        .scan-btn {
            padding: 25px 60px;
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent), var(--cyan), var(--info));
            color: var(--dark-bg);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: var(--transition);
            box-shadow: 0 20px 50px rgba(100, 255, 218, 0.4);
            position: relative;
            overflow: hidden;
            letter-spacing: 1px;
        }

        .scan-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: 0.5s;
        }

        .scan-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 30px 70px rgba(100, 255, 218, 0.5);
        }

        .scan-btn:hover::before {
            left: 100%;
        }

        .features-banner {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 50px 0;
            flex-wrap: wrap;
        }

        .feature-badge {
            padding: 20px 35px;
            border-radius: 20px;
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: var(--transition);
            backdrop-filter: blur(20px);
            border: 2px solid transparent;
            cursor: pointer;
            min-width: 250px;
            justify-content: center;
        }

        .feature-badge:hover {
            transform: translateY(-5px) scale(1.05);
        }

        .feature-badge.blockchain {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.2), rgba(138, 43, 226, 0.1));
            color: var(--purple);
            border-color: rgba(138, 43, 226, 0.3);
            box-shadow: 0 15px 40px rgba(138, 43, 226, 0.2);
        }

        .feature-badge.ai {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
            color: var(--info);
            border-color: rgba(59, 130, 246, 0.3);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.2);
        }

        .feature-badge.gps {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(6, 182, 212, 0.1));
            color: var(--cyan);
            border-color: rgba(6, 182, 212, 0.3);
            box-shadow: 0 15px 40px rgba(6, 182, 212, 0.2);
        }

        /* ========== MEDICINE CONTENT ========== */
        .medicine-content {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px;
            position: relative;
            min-height: 100vh;
        }

        .medicine-content.active {
            display: block;
            animation: slideUp 0.5s ease;
        }

        .controls-bar {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 1000;
            display: none;
            gap: 25px;
            align-items: center;
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            padding: 20px 25px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        .controls-bar.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .voice-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .voice-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--cyan));
            color: var(--dark-bg);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: var(--transition);
            box-shadow: 0 15px 35px rgba(100, 255, 218, 0.3);
        }

        .voice-btn:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 20px 45px rgba(100, 255, 218, 0.4);
        }

        .voice-btn.playing {
            animation: pulse 1.5s infinite;
        }

        .medicine-card {
            background: linear-gradient(135deg, var(--container-bg), rgba(17, 34, 64, 0.95));
            border-radius: 35px;
            padding: 50px;
            margin: 4rem 0;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(30px);
            border-left: 8px solid var(--success);
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.5);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .medicine-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--accent), var(--purple), var(--info));
        }

        .medicine-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 50px 100px rgba(0, 0, 0, 0.6);
        }

        .medicine-card.counterfeit {
            border-left-color: var(--danger);
            animation: shake 0.8s ease;
        }

        .medicine-card.warning {
            border-left-color: var(--warning);
        }

        .medicine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap;
            gap: 30px;
        }

        .medicine-header-left {
            flex: 1;
            min-width: 300px;
        }

        .medicine-name {
            font-size: 2.8rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--light-text), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.3;
            margin-bottom: 15px;
        }

        .medicine-batch {
            background: linear-gradient(135deg, rgba(100, 255, 218, 0.2), rgba(100, 255, 218, 0.1));
            color: var(--accent);
            padding: 15px 30px;
            border-radius: 30px;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            border: 2px solid rgba(100, 255, 218, 0.3);
            display: inline-block;
            font-weight: 600;
            transition: var(--transition);
            cursor: pointer;
        }

        .medicine-batch:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(100, 255, 218, 0.2);
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 20px;
            padding: 20px 35px;
            border-radius: 30px;
            font-weight: 800;
            font-size: 1.3rem;
            transition: var(--transition);
            backdrop-filter: blur(20px);
            border: 3px solid transparent;
        }

        .status-indicator.verified {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
            color: var(--success);
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: 0 15px 40px rgba(16, 185, 129, 0.2);
            animation: pulse 2s infinite;
        }

        .status-indicator.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
            color: var(--warning);
            border-color: rgba(245, 158, 11, 0.3);
            box-shadow: 0 15px 40px rgba(245, 158, 11, 0.2);
        }

        .status-indicator.danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
            color: var(--danger);
            border-color: rgba(239, 68, 68, 0.3);
            box-shadow: 0 15px 40px rgba(239, 68, 68, 0.2);
            animation: pulse 1.5s infinite;
        }

        .medicine-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .info-card {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 30px;
            background: rgba(10, 25, 47, 0.7);
            border-radius: 25px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            backdrop-filter: blur(20px);
        }

        .info-card:hover {
            transform: translateX(12px);
            border-color: var(--accent);
            box-shadow: 0 20px 50px rgba(100, 255, 218, 0.1);
        }

        .info-label {
            color: var(--muted-text);
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }

        .info-label i {
            color: var(--accent);
            font-size: 1.2rem;
        }

        .info-value {
            font-weight: 700;
            color: var(--light-text);
            font-size: 1.5rem;
            line-height: 1.4;
        }

        .blockchain-verification {
            background: rgba(10, 25, 47, 0.7);
            border-radius: 30px;
            padding: 40px;
            margin: 40px 0;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(25px);
        }

        .blockchain-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .blockchain-header i {
            font-size: 2.5rem;
            color: var(--accent);
        }

        .blockchain-header h3 {
            font-size: 2rem;
            background: linear-gradient(135deg, var(--accent), var(--cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .verification-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
        }

        .verification-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }

        .verification-label {
            color: var(--muted-text);
            font-size: 0.9rem;
            margin-bottom: 10px;
            display: block;
        }

        .verification-value {
            font-weight: 700;
            font-size: 1.2rem;
            word-break: break-all;
        }

        .alert-banner {
            margin-top: 30px;
            padding: 30px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
            border-radius: 20px;
            border-left: 6px solid var(--danger);
            backdrop-filter: blur(20px);
        }

        .alert-banner.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
            border-left-color: var(--warning);
        }

        .alert-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .alert-header i {
            font-size: 1.8rem;
            color: var(--danger);
        }

        .alert-header.warning i {
            color: var(--warning);
        }

        .alert-header h4 {
            color: var(--danger);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .alert-header.warning h4 {
            color: var(--warning);
        }

        .alert-content {
            color: var(--light-text);
            font-size: 1.1rem;
            line-height: 1.7;
        }

        /* ========== TIMELINE WITH MAPS ========== */
        .journey-section {
            margin: 5rem 0;
        }

        .section-title {
            font-size: 3.2rem;
            margin-bottom: 20px;
            color: var(--accent);
            text-align: center;
            font-weight: 900;
            position: relative;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 5px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            border-radius: 5px;
        }

        .section-subtitle {
            color: var(--light-text);
            text-align: center;
            margin-bottom: 4rem;
            font-size: 1.4rem;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.8;
        }

        .timeline-container {
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
        }

        .timeline-line {
            position: absolute;
            left: 100px;
            top: 120px;
            bottom: 120px;
            width: 6px;
            background: linear-gradient(to bottom,
                    var(--accent),
                    var(--purple),
                    var(--info),
                    var(--success),
                    var(--warning));
            z-index: 1;
            border-radius: 6px;
        }

        .timeline-line::after {
            content: '';
            position: absolute;
            top: 0;
            left: -2px;
            right: -2px;
            bottom: 0;
            background: linear-gradient(to bottom, transparent, rgba(100, 255, 218, 0.8), transparent);
            animation: flow 3s linear infinite;
        }

        @keyframes flow {
            0% {
                background-position: 0% 0%;
            }

            100% {
                background-position: 0% 100%;
            }
        }

        .timeline-step {
            display: flex;
            align-items: center;
            margin-bottom: 60px;
            position: relative;
            z-index: 2;
            opacity: 0;
            transform: translateX(-30px);
            transition: all 0.6s ease;
        }

        .timeline-step.visible {
            opacity: 1;
            transform: translateX(0);
        }

        .step-circle {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: white;
            font-size: 40px;
            margin-right: 50px;
            position: relative;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
            transition: var(--transition);
            border: 6px solid white;
            z-index: 2;
        }

        .step-circle:hover {
            transform: rotate(360deg) scale(1.1);
            box-shadow: 0 35px 80px rgba(0, 0, 0, 0.6);
        }

        .step-circle.manufacturer {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
        }

        .step-circle.distributor {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .step-circle.wholesaler {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
        }

        .step-circle.pharmacy {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .step-circle.customer {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .step-content {
            background: linear-gradient(135deg, var(--container-bg), rgba(17, 34, 64, 0.95));
            border-radius: 30px;
            padding: 40px;
            flex: 1;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(25px);
            transition: var(--transition);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.4);
        }

        .step-content:hover {
            transform: translateY(-8px);
            border-color: var(--accent);
            box-shadow: 0 35px 80px rgba(0, 0, 0, 0.5);
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap;
            gap: 20px;
        }

        .step-title {
            font-size: 2rem;
            font-weight: 800;
            color: var(--light-text);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .step-time {
            color: var(--accent);
            font-size: 1.1rem;
            background: rgba(100, 255, 218, 0.2);
            padding: 12px 25px;
            border-radius: 25px;
            border: 2px solid rgba(100, 255, 218, 0.3);
            font-weight: 700;
            backdrop-filter: blur(20px);
        }

        .step-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .detail-card {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 25px;
            background: rgba(10, 25, 47, 0.7);
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }

        .detail-label {
            font-size: 0.9rem;
            color: var(--muted-text);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
        }

        .detail-value {
            font-weight: 700;
            color: var(--light-text);
            font-size: 1.3rem;
        }

        .tx-hash {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: var(--muted-text);
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 15px;
            word-break: break-all;
            margin-top: 10px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            cursor: pointer;
        }

        .tx-hash:hover {
            background: rgba(0, 0, 0, 0.4);
            transform: translateX(8px);
        }

        /* ========== MAP CONTAINERS ========== */
        .map-container {
            width: 100%;
            height: 300px;
            border-radius: 20px;
            overflow: hidden;
            margin-top: 25px;
            border: 3px solid var(--border-color);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .map-container .leaflet-container {
            border-radius: 17px;
        }

        .map-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(10, 25, 47, 0.9);
            padding: 15px 25px;
            border-radius: 15px;
            border: 2px solid var(--accent);
            backdrop-filter: blur(10px);
            color: var(--accent);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ========== BACK BUTTON ========== */
        .back-section {
            text-align: center;
            margin: 60px 0;
        }

        .back-btn {
            padding: 22px 50px;
            border-radius: 20px;
            border: 3px solid var(--accent);
            background: rgba(100, 255, 218, 0.1);
            color: var(--accent);
            font-weight: 800;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 20px;
            transition: var(--transition);
            font-size: 1.3rem;
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
            letter-spacing: 1px;
        }

        .back-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .back-btn:hover {
            background: rgba(100, 255, 218, 0.2);
            transform: translateY(-5px);
            box-shadow: 0 25px 60px rgba(100, 255, 218, 0.2);
        }

        .back-btn:hover::before {
            left: 100%;
        }

        /* ========== BLOCKCHAIN EXPLAINER ========== */
        .blockchain-explainer {
            background: linear-gradient(135deg, var(--container-bg), rgba(17, 34, 64, 0.95));
            border-radius: 35px;
            padding: 60px;
            margin: 5rem 0;
            border: 2px solid var(--accent);
            position: relative;
            overflow: hidden;
        }

        .blockchain-explainer::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--accent), var(--purple), var(--info), var(--accent));
            z-index: -1;
            border-radius: 37px;
            animation: borderGlow 3s linear infinite;
            background-size: 400% 400%;
        }

        .explainer-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .explainer-header h2 {
            font-size: 3rem;
            background: linear-gradient(135deg, var(--accent), var(--cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }

        .explainer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 40px;
            margin-bottom: 50px;
        }

        .explainer-card {
            background: rgba(10, 25, 47, 0.7);
            border-radius: 25px;
            padding: 40px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .explainer-card:hover {
            transform: translateY(-10px);
            border-color: var(--accent);
            box-shadow: 0 30px 60px rgba(100, 255, 218, 0.1);
        }

        .explainer-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--accent), rgba(100, 255, 218, 0.3));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            font-size: 2rem;
            color: var(--dark-bg);
        }

        .explainer-card h3 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: var(--light-text);
        }

        .explainer-card p {
            color: var(--muted-text);
            line-height: 1.8;
            font-size: 1.1rem;
        }

        .blockchain-visual {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, rgba(10, 25, 47, 0.9), rgba(17, 34, 64, 0.9));
            border-radius: 25px;
            border: 2px solid var(--accent);
            position: relative;
            overflow: hidden;
            margin: 40px 0;
        }

        .blockchain-chain {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 20px;
            gap: 20px;
        }

        .block {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--info), var(--purple));
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            position: relative;
            animation: float 3s ease-in-out infinite;
        }

        .block:nth-child(2) {
            animation-delay: 0.2s;
        }

        .block:nth-child(3) {
            animation-delay: 0.4s;
        }

        .block:nth-child(4) {
            animation-delay: 0.6s;
        }

        .block:nth-child(5) {
            animation-delay: 0.8s;
        }

        .block::before {
            content: '';
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 4px;
            background: var(--accent);
        }

        .block:last-child::before {
            display: none;
        }

        .block i {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* ========== FOOTER ========== */
        .footer {
            text-align: center;
            padding: 60px 0;
            margin-top: 80px;
            border-top: 2px solid var(--border-color);
            color: var(--muted-text);
            position: relative;
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
        }

        .footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg,
                    transparent,
                    var(--accent),
                    var(--purple),
                    var(--info),
                    transparent);
        }

        .footer p {
            margin-bottom: 20px;
            font-size: 1.2rem;
            line-height: 1.8;
        }

        .footer-badge {
            display: inline-flex;
            align-items: center;
            gap: 20px;
            background: linear-gradient(135deg, rgba(100, 255, 218, 0.2), rgba(100, 255, 218, 0.1));
            color: var(--accent);
            padding: 20px 40px;
            border-radius: 30px;
            margin-top: 30px;
            border: 3px solid rgba(100, 255, 218, 0.3);
            font-weight: 700;
            backdrop-filter: blur(20px);
            transition: var(--transition);
            font-size: 1.1rem;
        }

        .footer-badge:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 20px 50px rgba(100, 255, 218, 0.2);
        }

        /* ========== LOADING OVERLAY ========== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 25, 47, 0.98);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(20px);
            display: none;
        }

        .loading-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .loading-spinner {
            width: 100px;
            height: 100px;
            border: 5px solid transparent;
            border-top: 5px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: relative;
            margin-bottom: 40px;
        }

        .loading-spinner::before,
        .loading-spinner::after {
            content: '';
            position: absolute;
            border: 5px solid transparent;
            border-radius: 50%;
        }

        .loading-spinner::before {
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-top: 5px solid var(--purple);
            animation: spin 1.5s linear infinite reverse;
        }

        .loading-spinner::after {
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border-top: 5px solid var(--info);
            animation: spin 2s linear infinite;
        }

        .loading-text {
            color: var(--accent);
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            animation: pulse 2s infinite;
        }

        /* ========== CUSTOM SCROLLBAR ========== */
        ::-webkit-scrollbar {
            width: 14px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark-bg);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--accent), var(--purple));
            border-radius: 10px;
            border: 3px solid var(--dark-bg);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--purple), var(--accent));
        }

        /* ========== RESPONSIVE DESIGN ========== */
        @media (max-width: 1200px) {
            .app-title {
                font-size: 3.5rem;
            }

            .section-title {
                font-size: 2.8rem;
            }

            .medicine-name {
                font-size: 2.4rem;
            }
        }

        @media (max-width: 992px) {
            .app-title {
                font-size: 3rem;
            }

            .main-logo {
                width: 160px;
                height: 160px;
            }

            .main-logo i {
                font-size: 65px;
            }

            .scanner-content {
                gap: 40px;
            }

            .step-circle {
                width: 140px;
                height: 140px;
                font-size: 35px;
                margin-right: 40px;
            }

            .timeline-line {
                left: 70px;
            }
        }

        @media (max-width: 768px) {
            .app-title {
                font-size: 2.5rem;
            }

            .main-logo {
                width: 130px;
                height: 130px;
            }

            .main-logo i {
                font-size: 55px;
            }

            .scan-btn {
                padding: 22px 45px;
                font-size: 1.3rem;
            }

            .help-modal,
            .ai-modal,
            .scanner-modal {
                padding: 40px 30px;
            }

            .scanner-content {
                grid-template-columns: 1fr;
            }

            .timeline-step {
                flex-direction: column;
                align-items: flex-start;
            }

            .step-circle {
                margin: 0 0 30px 0;
                width: 120px;
                height: 120px;
                font-size: 30px;
            }

            .timeline-line {
                left: 60px;
                top: 60px;
                bottom: 60px;
            }

            .help-btn,
            .ai-assistant-btn {
                bottom: 20px;
                right: 20px;
                left: auto;
                padding: 14px 22px;
            }

            .ai-assistant-btn {
                bottom: 90px;
                left: 20px;
                right: auto;
            }

            .blockchain-explainer {
                padding: 40px 25px;
            }

            .explainer-card {
                padding: 30px 20px;
            }

            .login-content {
                padding: 30px 20px;
            }
        }

        @media (max-width: 480px) {
            .app-title {
                font-size: 2rem;
            }

            .app-tagline {
                font-size: 1.1rem;
                padding: 20px;
            }

            .scan-btn {
                padding: 20px 35px;
                font-size: 1.1rem;
            }

            .feature-badge {
                min-width: 100%;
            }

            .medicine-card {
                padding: 30px 20px;
            }

            .medicine-name {
                font-size: 2rem;
            }

            .section-title {
                font-size: 2.2rem;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }

        /* Unified gradient for entire chat grid */
        .chat-container,
        .chat-grid,
        .main-grid {
            background: linear-gradient(135deg, #4f6cff 0%, #3a7bd5 50%, #00d2ff 100%);
        }

        .chat-header,
        .chat-body,
        .chat-messages,
        .suggestions,
        .chat-input-area {
            background: transparent !important;
        }


        /* FIX: Unified gradient for entire AI chat container */
        .ai-chat-container {
            background: linear-gradient(135deg, #4f6cff 0%, #3a7bd5 50%, #00d2ff 100%);
        }

        .ai-chat-container * {
            background: transparent;
        }
    </style>

    <script>
        /* GLOBAL FIX: disable all alert popups (hackathon-safe) */
        window.alert = function () { };
    </script>

</head>

<body>
    <!-- Background Effects -->
    <div class="bg-animation"></div>
    <div class="grid-overlay"></div>
    <div class="particles" id="particles"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Verifying Medicine</div>
    </div>

    <!-- Login Modal -->
    <div class="login-modal" id="loginModal">
        <div class="login-content">
            <div class="login-logo">
                <i class="fas fa-shield-alt"></i>
                <h1>MedChain</h1>
                <p>Secure Blockchain Medicine Verification System</p>
            </div>

            <!-- Tabs for Login/Register -->
            <div class="login-tabs">
                <button class="login-tab active" id="loginTabBtn">Login</button>
                <button class="login-tab" id="registerTabBtn">Register</button>
            </div>

            <!-- Error/Success Messages -->
            <div class="login-error" id="loginError">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="errorMessage">Invalid credentials. Please try again.</span>
            </div>

            <div class="login-success" id="loginSuccess">
                <i class="fas fa-check-circle"></i>
                <span id="successMessage">Registration successful! You can now login.</span>
            </div>

            <!-- Login Form -->
            <form class="login-form active" id="loginForm">
                <div class="form-group">
                    <label for="loginEmail"><i class="fas fa-envelope"></i> Email Address</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required>
                </div>

                <div class="form-group">
                    <label for="loginPassword"><i class="fas fa-lock"></i> Password</label>
                    <div class="password-container">
                        <input type="password" id="loginPassword" placeholder="Enter your password" required>
                        <button type="button" class="toggle-password" data-target="loginPassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="remember-forgot">
                    <label class="remember-me">
                        <input type="checkbox" id="rememberMe">
                        <span>Remember me</span>
                    </label>
                    <a href="#" class="forgot-password" id="forgotPassword">Forgot Password?</a>
                </div>

                <button type="submit" class="login-btn" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Sign In</span>
                </button>

                <div class="login-switch">
                    <span>Don't have an account?</span>
                    <a href="#" id="switchToRegister">Create Account</a>
                </div>
            </form>

            <!-- Registration Form -->
            <form class="login-form" id="registerForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName"><i class="fas fa-user"></i> First Name</label>
                        <input type="text" id="firstName" placeholder="Enter first name" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName"><i class="fas fa-user"></i> Last Name</label>
                        <input type="text" id="lastName" placeholder="Enter last name" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="registerEmail"><i class="fas fa-envelope"></i> Email Address</label>
                    <input type="email" id="registerEmail" placeholder="Enter your email" required>
                </div>

                <div class="form-group">
                    <label for="phone"><i class="fas fa-phone"></i> Phone Number</label>
                    <input type="tel" id="phone" placeholder="Enter phone number" required>
                </div>

                <div class="form-group">
                    <label for="userRole"><i class="fas fa-user-tag"></i> User Role</label>
                    <select id="userRole" required>
                        <option value="">Select your role</option>
                        <option value="patient">Patient</option>
                        <option value="pharmacist">Pharmacist</option>
                        <option value="doctor">Doctor</option>
                        <option value="distributor">Distributor</option>
                        <option value="manufacturer">Manufacturer</option>
                        <option value="customer">Customer</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="registerPassword"><i class="fas fa-lock"></i> Password</label>
                    <div class="password-container">
                        <input type="password" id="registerPassword" placeholder="Create a strong password" required>
                        <button type="button" class="toggle-password" data-target="registerPassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirmPassword"><i class="fas fa-lock"></i> Confirm Password</label>
                    <div class="password-container">
                        <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
                        <button type="button" class="toggle-password" data-target="confirmPassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="remember-me">
                        <input type="checkbox" id="acceptTerms" required>
                        <span>I agree to the <a href="#" style="color: var(--accent);">Terms of Service</a> and <a
                                href="#" style="color: var(--accent);">Privacy Policy</a></span>
                    </label>
                </div>

                <button type="submit" class="login-btn" id="registerBtn">
                    <i class="fas fa-user-plus"></i>
                    <span>Create Account</span>
                </button>

                <div class="login-switch">
                    <span>Already have an account?</span>
                    <a href="#" id="switchToLogin">Sign In</a>
                </div>
            </form>
        </div>
    </div>

    <!-- User Menu (Shown After Login) -->
    <div class="user-menu" id="userMenu">
        <div class="user-avatar" id="userAvatar">JD</div>
        <div class="user-info">
            <div class="user-name" id="userName">John Doe</div>
            <div class="user-role" id="userRoleDisplay">Verified Pharmacist</div>
        </div>
        <button class="logout-btn" id="logoutBtn" title="Logout">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </div>

    <!-- Floating Buttons -->
    <div class="ai-assistant-btn" id="aiAssistantBtn">
        <i class="fas fa-robot"></i> AI Assistant
    </div>

    <div class="help-btn" id="helpBtn">
        <i class="fas fa-question-circle"></i> How it works
    </div>

    <!-- AI Assistant Modal -->
    <div class="modal-overlay" id="aiModal">
        <div class="ai-modal">
            <button class="close-ai" id="closeAiModal">
                <i class="fas fa-times"></i>
            </button>

            <div class="ai-header">
                <div class="ai-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div>
                    <h2>MedChain AI Assistant</h2>
                    <p style="color: var(--muted-text); margin-top: 10px;">Your personal guide for medicine safety</p>
                </div>
            </div>

            <div class="ai-chat-container" id="aiChat">
                <div class="chat-message ai">
                    <span class="sender">MedChain AI:</span>
                    <div class="content">
                        Hello! I'm your MedChain AI Assistant. I can help you with:
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            <li>Understanding medicine verification results</li>
                            <li>Explaining blockchain supply chain tracking</li>
                            <li>Guidance on counterfeit medicine identification</li>
                            <li>Storage and safety recommendations</li>
                            <li>Answering questions about medicine safety</li>
                        </ul>
                        How can I assist you today?
                    </div>
                </div>
            </div>

            <div class="quick-questions">
                <button class="quick-question" onclick="askAI('What does Verified status mean?')">
                    What does Verified status mean?
                </button>
                <button class="quick-question" onclick="askAI('How to identify counterfeit medicine?')">
                    How to identify counterfeit medicine?
                </button>
                <button class="quick-question" onclick="askAI('What is blockchain verification?')">
                    What is blockchain verification?
                </button>
                <button class="quick-question" onclick="askAI('Is expired medicine dangerous?')">
                    Is expired medicine dangerous?
                </button>
            </div>

            <div class="ai-input-area">
                <input type="text" class="ai-input" id="aiInput" placeholder="Ask me anything about medicine safety..."
                    onkeypress="handleAIKeyPress(event)">
                <button class="ai-send-btn" onclick="sendAIMessage()">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="helpModal">
        <div class="help-modal">
            <div class="help-header">
                <h2><i class="fas fa-info-circle"></i> How MedChain Works</h2>
                <p>Revolutionizing medicine verification with blockchain technology and AI-powered safety</p>
            </div>

            <div class="steps-grid">
                <div class="step-card">
                    <div class="step-number">1</div>
                    <h3>Scan Medicine QR</h3>
                    <p>Each medicine has a unique QR code linked to blockchain. Scan using phone camera or web scanner.
                    </p>
                </div>
                <div class="step-card">
                    <div class="step-number">2</div>
                    <h3>Fetch Public Record</h3>
                    <p>System retrieves immutable supply chain history from secure blockchain ledger in milliseconds.
                    </p>
                </div>
                <div class="step-card">
                    <div class="step-number">3</div>
                    <h3>Validate Journey</h3>
                    <p>AI verifies every step from manufacturer to pharmacy for authenticity and temperature compliance.
                    </p>
                </div>
                <div class="step-card">
                    <div class="step-number">4</div>
                    <h3>Show Safety Result</h3>
                    <p>Instant verification with visual & voice feedback. Complete supply chain visualization.</p>
                </div>
            </div>

            <div class="features-section">
                <h3><i class="fas fa-shield-alt"></i> Key Features</h3>
                <div class="features-grid">
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-ban"></i>
                        </div>
                        <div class="feature-text">
                            <strong>Detects Counterfeit Medicines</strong>
                            <small>Identifies fake medicines with broken supply chains</small>
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-thermometer-half"></i>
                        </div>
                        <div class="feature-text">
                            <strong>Temperature Monitoring</strong>
                            <small>Tracks temperature violations in real-time</small>
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <div class="feature-text">
                            <strong>Expiry Detection</strong>
                            <small>Alerts about expired or near-expiry medicines</small>
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-language"></i>
                        </div>
                        <div class="feature-text">
                            <strong>Voice Assistant</strong>
                            <small>English voice output for all verifications</small>
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-map-marked-alt"></i>
                        </div>
                        <div class="feature-text">
                            <strong>GPS Tracking</strong>
                            <small>Interactive maps of supply chain journey</small>
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="feature-text">
                            <strong>AI Assistant</strong>
                            <small>24/7 AI guidance for medicine safety</small>
                        </div>
                    </div>
                </div>
            </div>

            <button class="close-help" id="closeHelpModal">
                <i class="fas fa-qrcode"></i> Start Scanning
            </button>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div class="modal-overlay" id="scannerModal">
        <div class="scanner-modal">
            <button class="close-scanner" id="closeScannerModal">
                <i class="fas fa-times"></i>
            </button>

            <div class="scanner-header">
                <h2 class="scanner-title">Scan Medicine QR Code</h2>
                <p class="scanner-subtitle">Position QR code within frame to verify authenticity and track complete
                    supply chain journey</p>
            </div>

            <div class="scanner-content">
                <div class="scanner-visual">
                    <div class="qr-scanner-area">
                        <div class="scanner-frame"></div>
                    </div>

                    <div class="camera-controls">
                        <button class="camera-btn" id="toggleCamera">
                            <i class="fas fa-camera"></i> Toggle Camera
                        </button>
                        <button class="camera-btn" id="flashToggle">
                            <i class="fas fa-bolt"></i> Flash
                        </button>
                        <button class="camera-btn" id="uploadQR">
                            <i class="fas fa-upload"></i> Upload QR
                        </button>
                    </div>

                    <div class="demo-checklist">
                        <h4><i class="fas fa-clipboard-check"></i> Demo Checklist</h4>
                        <div class="checklist-items">
                            <div class="checklist-item">
                                <input type="checkbox" id="check1" checked>
                                <label for="check1">QR Scanner Working</label>
                            </div>
                            <div class="checklist-item">
                                <input type="checkbox" id="check2" checked>
                                <label for="check2">Fake vs Real Detection</label>
                            </div>
                            <div class="checklist-item">
                                <input type="checkbox" id="check3" checked>
                                <label for="check3">Supply Chain Timeline</label>
                            </div>
                            <div class="checklist-item">
                                <input type="checkbox" id="check4" checked>
                                <label for="check4">Voice Assistant</label>
                            </div>
                            <div class="checklist-item">
                                <input type="checkbox" id="check5" checked>
                                <label for="check5">GPS Location Tracking</label>
                            </div>
                            <div class="checklist-item">
                                <input type="checkbox" id="check6" checked>
                                <label for="check6">Duplicate Scan Detection</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="demo-section">
                    <h3>Demo Medicines (5 Scenarios)</h3>
                    <p>Click to simulate scanning each scenario and experience full verification process</p>

                    <div class="demo-buttons">
                        <button class="demo-btn verified" onclick="scanMedicine('MED20240001')">
                            <div class="btn-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div>
                                <strong> Verified Medicine</strong>
                                <small>Paracetamol 500mg  Complete journey  Safe to use</small>
                            </div>
                        </button>

                        <button class="demo-btn warning" onclick="scanMedicine('MED20240002')">
                            <div class="btn-icon">
                                <i class="fas fa-truck-moving"></i>
                            </div>
                            <div>
                                <strong> In Transit</strong>
                                <small>Amoxicillin  Missing final steps  Track with caution</small>
                            </div>
                        </button>

                        <button class="demo-btn danger" onclick="scanMedicine('EXPIRED001')">
                            <div class="btn-icon">
                                <i class="fas fa-calendar-times"></i>
                            </div>
                            <div>
                                <strong> Expired</strong>
                                <small>Expired Medicine  Past expiry date  Do not consume</small>
                            </div>
                        </button>

                        <button class="demo-btn danger" onclick="scanMedicine('FAKE001')">
                            <div class="btn-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div>
                                <strong> Counterfeit</strong>
                                <small>Fake Medicine  Tampered seals  Supply chain broken</small>
                            </div>
                        </button>

                        <button class="demo-btn info" onclick="scanMedicine('RECALL001')">
                            <div class="btn-icon">
                                <i class="fas fa-ban"></i>
                            </div>
                            <div>
                                <strong> Recalled</strong>
                                <small>Recalled Batch  Manufacturer recall  Return immediately</small>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Landing Page -->
    <div class="landing-screen" id="landingScreen">
        <div class="logo-container">
            <div class="logo-glow"></div>
            <div class="main-logo">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h1 class="app-title">MedChain</h1>
            <p class="app-tagline">
                Blockchain-Powered Medicine Verification System<br>
                Secure, Transparent & Immutable Supply Chain Tracking
            </p>
        </div>

        <div class="status-legend">
            <h4><i class="fas fa-key"></i> Status Guide</h4>
            <div class="legend-items">
                <div class="legend-item">
                    <span class="legend-dot verified"></span>
                    <span class="legend-text">Verified & Safe - Complete supply chain</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot warning"></span>
                    <span class="legend-text">In Transit / Warning - Missing some steps</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot danger"></span>
                    <span class="legend-text">Expired / Counterfeit / Recalled - Do not use</span>
                </div>
            </div>
        </div>

        <div class="features-banner">
            <div class="feature-badge blockchain">
                <i class="fab fa-ethereum"></i>
                Blockchain Verification
            </div>
            <div class="feature-badge ai">
                <i class="fas fa-robot"></i>
                AI Assistant
            </div>
            <div class="feature-badge gps">
                <i class="fas fa-map-marker-alt"></i>
                GPS Tracking
            </div>
        </div>

        <div class="scan-cta">
            <button class="scan-btn" id="startScanBtn">
                <i class="fas fa-qrcode"></i>
                <span>SCAN MEDICINE QR CODE</span>
            </button>
            <p style="color: var(--muted-text); margin-top: 25px; font-size: 1rem;">
                <i class="fas fa-info-circle"></i> Click above to scan or use demo options in scanner
            </p>
        </div>
    </div>

    <!-- Medicine Content -->
    <div class="medicine-content" id="medicineContent">
        <div class="controls-bar" id="controlsBar">
            <div class="voice-controls">
                <button class="voice-btn" id="voiceBtn">
                    <i class="fas fa-volume-up"></i>
                </button>
                <span style="color: var(--muted-text); font-size: 0.9rem;">Voice Assistant</span>
            </div>
        </div>

        <!-- Medicine content will be inserted here by JavaScript -->
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
        function getGreetingResponse(message) {
            const msg = message.toLowerCase().trim();

            const greetings = [
                "hi",
                "hello",
                "hey",
                "hai",
                "good morning",
                "good afternoon",
                "good evening"
            ];

            if (greetings.includes(msg)) {
                return "Hello! Im your MedChain AI Assistant. How can I help you with medicine safety or verification today?";
            }

            if (msg.includes("how are you")) {
                return "Im doing well, thank you! Im here to help you with medicine verification, safety checks, and counterfeit detection.";
            }

            if (msg === "thanks" || msg === "thank you") {
                return "Youre welcome! Let me know if you need help with anything related to medicine safety.";
            }

            return null;
        }

    </script>
    <script>
        // ========== STATE MANAGEMENT ==========
        let currentUser = null;
        let voicePlaying = false;
        let currentStatus = '';
        let scannedHistory = [];
        let currentMedicineData = null;
        let maps = [];

        // ========== USER DATABASE ==========
        let users = JSON.parse(localStorage.getItem('medchain_users')) || {
            'pharmacist@medchain.com': {
                password: 'Medchain@123',
                firstName: 'John',
                lastName: 'Doe',
                phone: '+1234567890',
                role: 'pharmacist',
                initials: 'JD',
                fullName: 'John Doe',
                roleName: 'Verified Pharmacist',
                registeredAt: new Date().toISOString()
            },
            'doctor@medchain.com': {
                password: 'Secure@456',
                firstName: 'Sarah',
                lastName: 'Smith',
                phone: '+1234567891',
                role: 'doctor',
                initials: 'SS',
                fullName: 'Dr. Sarah Smith',
                roleName: 'Medical Doctor',
                registeredAt: new Date().toISOString()
            },
            'patient@medchain.com': {
                password: 'Patient@123',
                firstName: 'Robert',
                lastName: 'Johnson',
                phone: '+1234567892',
                role: 'patient',
                initials: 'RJ',
                fullName: 'Robert Johnson',
                roleName: 'Patient',
                registeredAt: new Date().toISOString()
            },
            'customer@medchain.com': {
                password: 'Customer@123',
                firstName: 'Emily',
                lastName: 'Wilson',
                phone: '+1234567893',
                role: 'customer',
                initials: 'EW',
                fullName: 'Emily Wilson',
                roleName: 'Customer',
                registeredAt: new Date().toISOString()
            }
        };

        // ========== AI KNOWLEDGE BASE ==========
        const aiKnowledgeBase = {
            'verified': " <strong>Verified Status</strong> means this medicine has complete blockchain tracking from manufacturer to pharmacy. All supply chain steps are recorded on the immutable ledger, ensuring 100% authenticity and safety for consumption.",
            'counterfeit': " <strong>Counterfeit Medicine Identification:</strong><br>1. Check QR code verification status<br>2. Look for tampered or broken seals<br>3. Verify manufacturer details on blockchain<br>4. Check expiry date against ledger record<br>5. Report suspicious medicines immediately",
            'blockchain': " <strong>Blockchain Verification</strong> creates an immutable digital ledger of the medicine's entire journey. Each step (manufacturing, distribution, storage, delivery) is cryptographically recorded and cannot be altered, ensuring 100% transparency and preventing fraud.",
            'expired': " <strong>Expired Medicine Warning:</strong> Expired medicines may have degraded active ingredients, reduced effectiveness, or become toxic. NEVER consume expired medicines. Properly dispose of them at pharmacy collection points.",
            'safety': " <strong>Medicine Safety Tips:</strong><br>1. Always verify QR code before use<br>2. Store at recommended temperatures<br>3. Check expiry dates regularly<br>4. Buy only from licensed pharmacies<br>5. Report any adverse reactions"
        };

        // ========== LOCAL DEMO DATA (Fallback) ==========
        const localDemoData = {
            'MED20240001': {
                medicine: {
                    batch_id: 'MED20240001',
                    name: 'Paracetamol 500mg Tablets',
                    manufacturer: 'PharmaCorp India Ltd. (ISO Certified)',
                    expiry_date: '2025-12-15',
                    composition: 'Paracetamol 500mg',
                    temperature_range: '15-25C',
                    mfg_date: '2024-01-10',
                    status: 'VERIFIED'
                },
                supplyChain: [
                    {
                        step: 'manufacturer',
                        organization: 'PharmaCorp Manufacturing Unit',
                        timestamp: '2024-01-15 10:30:00',
                        location: 'Mumbai, Maharashtra',
                        temperature: '22C',
                        seal_status: 'INTACT',
                        tx_hash: '0x8a2be2f1c40f9d3e1234567890abcdef1234567890abcdef1234567890abcdef',
                        coordinates: '19.0760,72.8777'
                    },
                    {
                        step: 'distributor',
                        organization: 'MedDistro Logistics (Cold Chain Certified)',
                        timestamp: '2024-01-18 09:15:00',
                        location: 'Delhi Distribution Center',
                        temperature: '18C',
                        seal_status: 'VERIFIED',
                        tx_hash: '0x9b3ce1f2d50g0e4f234567890abcdef1234567890abcdef1234567890abcdef',
                        coordinates: '28.6139,77.2090'
                    },
                    {
                        step: 'wholesaler',
                        organization: 'HealthWholesale Corporation',
                        timestamp: '2024-01-20 14:45:00',
                        location: 'Chennai Warehouse',
                        temperature: '20C',
                        seal_status: 'INTACT',
                        tx_hash: '0x7c4df2g3e60h1g5f34567890abcdef1234567890abcdef1234567890abcdef',
                        coordinates: '13.0827,80.2707'
                    },
                    {
                        step: 'pharmacy',
                        organization: 'CityMed Pharmacy Chain (License: PH-2024-001)',
                        timestamp: '2024-01-22 11:30:00',
                        location: 'Bengaluru Branch',
                        temperature: '23C',
                        seal_status: 'VERIFIED',
                        tx_hash: '0x5d6eg3h4i70j2h6g4567890abcdef1234567890abcdef1234567890abcdef',
                        coordinates: '12.9716,77.5946'
                    },
                    {
                        step: 'customer',
                        organization: 'Verified Purchase - Safe for Consumption',
                        timestamp: '2024-01-25 16:20:00',
                        location: 'Customer Location Verified',
                        temperature: '25C',
                        seal_status: 'AUTHENTIC',
                        tx_hash: '0x3e4fh5i6j80k3i7h567890abcdef1234567890abcdef1234567890abcdef',
                        coordinates: '12.9716,77.5946'
                    }
                ],
                blockchainVerification: {
                    verified: true,
                    status: 'VERIFIED',
                    txHash: '0x8a2be2f1c40f9d3e1234567890abcdef1234567890abcdef1234567890abcdef',
                    verificationId: 'VRF-2024-001-ABCD',
                    blockNumber: 17562345,
                    timestamp: Date.now()
                }
            },
            'MED20240002': {
                medicine: {
                    batch_id: 'MED20240002',
                    name: 'Amoxicillin 250mg Capsules',
                    manufacturer: 'BioMed Solutions (FDA Approved)',
                    expiry_date: '2025-06-30',
                    composition: 'Amoxicillin Trihydrate',
                    temperature_range: '2-8C (Cold Chain)',
                    mfg_date: '2024-01-05',
                    status: 'IN_TRANSIT'
                },
                supplyChain: [
                    {
                        step: 'manufacturer',
                        organization: 'BioMed Hyderabad Plant',
                        timestamp: '2024-01-20 09:00:00',
                        location: 'Hyderabad, Telangana',
                        temperature: '5C',
                        seal_status: 'INTACT',
                        tx_hash: '0x1a2bc3d4e50f6g7h8901234567890abcdef1234567890abcdef12345678',
                        coordinates: '17.3850,78.4867'
                    },
                    {
                        step: 'distributor',
                        organization: 'In Transit - Cold Chain Monitoring Active',
                        timestamp: 'Current Location  Live Tracking',
                        location: 'GPS: 20.5N, 78.3E  En route to Chennai',
                        temperature: '4C',
                        seal_status: 'MONITORING',
                        tx_hash: '0x2b3cd4e5f60g7h8i901234567890abcdef1234567890abcdef123456789',
                        coordinates: '20.5937,78.9629'
                    },
                    {
                        step: 'wholesaler',
                        organization: 'NOT REACHED - Expected in 2 days',
                        timestamp: 'Pending',
                        location: 'To be updated',
                        temperature: '--',
                        seal_status: 'PENDING',
                        tx_hash: 'PENDING_TRANSACTION',
                        coordinates: null
                    },
                    {
                        step: 'pharmacy',
                        organization: 'NOT REACHED',
                        timestamp: 'Pending',
                        location: 'To be updated',
                        temperature: '--',
                        seal_status: 'PENDING',
                        tx_hash: 'PENDING_TRANSACTION',
                        coordinates: null
                    }
                ],
                blockchainVerification: {
                    verified: false,
                    status: 'IN_TRANSIT',
                    txHash: '0x2b3cd4e5f60g7h8i901234567890abcdef1234567890abcdef123456789',
                    verificationId: 'VRF-2024-002-EFGH',
                    blockNumber: 17562456,
                    timestamp: Date.now()
                }
            },
            'EXPIRED001': {
                medicine: {
                    batch_id: 'EXPIRED001',
                    name: 'Expired Medicine Sample',
                    manufacturer: 'Unknown Source (Unverified)',
                    expiry_date: '2021-12-31',
                    composition: 'Unknown Composition',
                    temperature_range: 'Not Monitored',
                    mfg_date: '2020-06-15',
                    status: 'EXPIRED'
                },
                supplyChain: [
                    {
                        step: 'manufacturer',
                        organization: 'Unverified Manufacturer',
                        timestamp: 'Unknown Date',
                        location: 'Unknown Location',
                        temperature: 'Unknown',
                        seal_status: 'COMPROMISED',
                        tx_hash: '0x0000000000000000000000000000000000000000000000000000000000000000',
                        coordinates: null
                    }
                ],
                blockchainVerification: {
                    verified: false,
                    status: 'EXPIRED',
                    txHash: 'INVALID',
                    verificationId: 'INVALID-VERIFICATION',
                    blockNumber: 0,
                    timestamp: Date.now()
                }
            },
            'FAKE001': {
                medicine: {
                    batch_id: 'FAKE001',
                    name: 'Suspicious Medicine Batch',
                    manufacturer: 'Unverified Laboratory',
                    expiry_date: '2026-03-15',
                    composition: 'Unknown Chemical Mixture',
                    temperature_range: 'Unknown - No Monitoring',
                    mfg_date: '2023-11-20',
                    status: 'COUNTERFEIT'
                },
                supplyChain: [
                    {
                        step: 'manufacturer',
                        organization: 'Suspicious Manufacturing Facility',
                        timestamp: '2024-01-10 14:00:00',
                        location: 'Unregistered Location',
                        temperature: '30C',
                        seal_status: 'TAMPERED',
                        tx_hash: '0xaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa',
                        coordinates: null
                    }
                ],
                blockchainVerification: {
                    verified: false,
                    status: 'COUNTERFEIT',
                    txHash: 'FAKE_HASH',
                    verificationId: 'FAKE-VERIFICATION-ID',
                    blockNumber: 0,
                    timestamp: Date.now()
                }
            },
            'RECALL001': {
                medicine: {
                    batch_id: 'RECALL001',
                    name: 'Recalled Medicine Batch',
                    manufacturer: 'MediSafe Pharmaceuticals',
                    expiry_date: '2025-09-30',
                    composition: 'Active Ingredient + Excipients',
                    temperature_range: '2-8C',
                    mfg_date: '2023-12-01',
                    status: 'RECALLED'
                },
                supplyChain: [
                    {
                        step: 'manufacturer',
                        organization: 'MediSafe Manufacturing Unit',
                        timestamp: '2023-12-10 11:00:00',
                        location: 'Pune, Maharashtra',
                        temperature: '6C',
                        seal_status: 'RECALLED',
                        tx_hash: '0xbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb',
                        coordinates: '18.5204,73.8567'
                    },
                    {
                        step: 'recall',
                        organization: 'RECALL NOTICE: DO NOT DISTRIBUTE',
                        timestamp: '2024-01-05 10:00:00',
                        location: 'National Drug Control Authority',
                        temperature: '--',
                        seal_status: 'RECALLED',
                        tx_hash: '0xcccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc',
                        coordinates: '28.6139,77.2090'
                    }
                ],
                blockchainVerification: {
                    verified: false,
                    status: 'RECALLED',
                    txHash: 'RECALL_ALERT_HASH',
                    verificationId: 'RECALL-VERIFICATION',
                    blockNumber: 17563000,
                    timestamp: Date.now(),
                    recall_reason: 'Potential contamination detected during quality check'
                }
            }
        };

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function () {
            initParticles();
            setupEventListeners();
            initAuth();
            checkBackendHealth(); // Added backend health check

            // Check if user is already logged in
            const savedUser = localStorage.getItem('medchain_current_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    handleLoginSuccess();
                } catch (e) {
                    localStorage.removeItem('medchain_current_user');
                }
            }
        });

        function initParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 80;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';

                const left = Math.random() * 100;
                const top = Math.random() * 100;
                const delay = Math.random() * 20;
                const duration = 20 + Math.random() * 15;
                const size = 1 + Math.random() * 4;

                particle.style.left = `${left}%`;
                particle.style.top = `${top}%`;
                particle.style.animationDelay = `${delay}s`;
                particle.style.animationDuration = `${duration}s`;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.opacity = 0.2 + Math.random() * 0.6;
                particle.style.background = `hsl(${Math.random() * 60 + 160}, 100%, 70%)`;

                particlesContainer.appendChild(particle);
            }
        }

        // ========== BACKEND HEALTH CHECK ==========
        function checkBackendHealth() {
            fetch('http://localhost:3000/api/health')
                .then(response => response.json())
                .then(data => {
                    console.log(' Backend is running:', data.message);
                })
                .catch(error => {
                    console.warn(' Backend not responding. Using demo mode.');
                });
        }

        // ========== AUTHENTICATION FUNCTIONS ==========
        function initAuth() {
            // Tab switching
            document.getElementById('loginTabBtn').addEventListener('click', () => switchAuthTab('login'));
            document.getElementById('registerTabBtn').addEventListener('click', () => switchAuthTab('register'));
            document.getElementById('switchToRegister').addEventListener('click', (e) => {
                e.preventDefault();
                switchAuthTab('register');
            });
            document.getElementById('switchToLogin').addEventListener('click', (e) => {
                e.preventDefault();
                switchAuthTab('login');
            });

            // Toggle password visibility
            document.querySelectorAll('.toggle-password').forEach(btn => {
                btn.addEventListener('click', function () {
                    const targetId = this.getAttribute('data-target');
                    const passwordInput = document.getElementById(targetId);
                    const icon = this.querySelector('i');

                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        icon.className = 'fas fa-eye-slash';
                    } else {
                        passwordInput.type = 'password';
                        icon.className = 'fas fa-eye';
                    }
                });
            });

            // Login form submission
            document.getElementById('loginForm').addEventListener('submit', function (e) {
                e.preventDefault();
                handleLogin();
            });

            // Register form submission
            document.getElementById('registerForm').addEventListener('submit', function (e) {
                e.preventDefault();
                handleRegister();
            });

            // Forgot password
            document.getElementById('forgotPassword').addEventListener('click', function (e) {
                e.preventDefault();
                handleForgotPassword();
            });

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        }

        function switchAuthTab(tab) {
            // Update tabs
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));

            if (tab === 'login') {
                document.getElementById('loginTabBtn').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.getElementById('registerTabBtn').classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }

            // Clear messages
            document.getElementById('loginError').classList.remove('show');
            document.getElementById('loginSuccess').classList.remove('show');
        }

        function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            const loginError = document.getElementById('loginError');
            const loginBtn = document.getElementById('loginBtn');

            // Reset error
            loginError.classList.remove('show');

            // Validate inputs
            if (!email || !password) {
                showAuthError('Please enter both email and password');
                return;
            }

            // Disable login button during processing
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';

            // Simulate API call delay
            setTimeout(() => {
                // Check credentials
                if (users[email] && users[email].password === password) {
                    currentUser = {
                        email: email,
                        firstName: users[email].firstName,
                        lastName: users[email].lastName,
                        fullName: users[email].fullName,
                        phone: users[email].phone,
                        role: users[email].role,
                        roleName: getRoleName(users[email].role),
                        initials: users[email].initials,
                        registeredAt: users[email].registeredAt
                    };

                    // Save to localStorage if remember me is checked
                    if (rememberMe) {
                        localStorage.setItem('medchain_current_user', JSON.stringify(currentUser));
                    }

                    handleLoginSuccess();
                } else {
                    showAuthError('Invalid email or password. Please try again.');
                }

                // Re-enable login button
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
            }, 1500);
        }

        function handleRegister() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('registerEmail').value.trim().toLowerCase();
            const phone = document.getElementById('phone').value.trim();
            const role = document.getElementById('userRole').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const acceptTerms = document.getElementById('acceptTerms').checked;
            const authError = document.getElementById('loginError');
            const authSuccess = document.getElementById('loginSuccess');
            const registerBtn = document.getElementById('registerBtn');

            // Reset messages
            authError.classList.remove('show');
            authSuccess.classList.remove('show');

            // Validate inputs
            if (!firstName || !lastName || !email || !phone || !role || !password || !confirmPassword) {
                showAuthError('Please fill in all required fields');
                return;
            }

            if (!acceptTerms) {
                showAuthError('You must accept the Terms of Service and Privacy Policy');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showAuthError('Please enter a valid email address');
                return;
            }

            // Check if email already exists
            if (users[email]) {
                showAuthError('This email is already registered. Please use a different email or login.');
                return;
            }

            // Check password match
            if (password !== confirmPassword) {
                showAuthError('Passwords do not match');
                return;
            }

            // Disable register button during processing
            registerBtn.disabled = true;
            registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';

            // Simulate API call delay
            setTimeout(() => {
                // Create new user
                const initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
                const fullName = `${firstName} ${lastName}`;

                users[email] = {
                    password: password,
                    firstName: firstName,
                    lastName: lastName,
                    phone: phone,
                    role: role,
                    initials: initials,
                    fullName: fullName,
                    roleName: getRoleName(role),
                    registeredAt: new Date().toISOString()
                };

                // Save to localStorage
                localStorage.setItem('medchain_users', JSON.stringify(users));

                // Show success message
                authSuccess.classList.add('show');
                document.getElementById('successMessage').textContent =
                    'Registration successful! You can now login.';

                // Clear form
                document.getElementById('registerForm').reset();

                // Switch to login tab after 2 seconds
                setTimeout(() => {
                    switchAuthTab('login');
                    authSuccess.classList.remove('show');
                }, 2000);

                // Re-enable register button
                registerBtn.disabled = false;
                registerBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
            }, 2000);
        }

        // FIX 2: Updated getRoleName function
        function getRoleName(role) {
            const roleNames = {
                'patient': 'Patient',
                'pharmacist': 'Verified Pharmacist',
                'doctor': 'Medical Doctor',
                'distributor': 'Medicine Distributor',
                'manufacturer': 'Medicine Manufacturer',
                'customer': 'Customer'  // Added customer role
            };
            return roleNames[role] || 'User';
        }

        function showAuthError(message) {
            const authError = document.getElementById('loginError');
            const errorMessage = document.getElementById('errorMessage');

            errorMessage.textContent = message;
            authError.classList.add('show');

            // Auto-hide error after 5 seconds
            setTimeout(() => {
                authError.classList.remove('show');
            }, 5000);
        }

        function handleForgotPassword() {
            const email = prompt('Please enter your email address to reset your password:');
            if (email) {
                if (users[email.toLowerCase()]) {
                    alert(`Password reset instructions have been sent to ${email}. Please check your email.`);
                } else {
                    alert('Email not found. Please check your email address.');
                }
            }
        }

        // FIX 3: Updated handleLoginSuccess function
        function handleLoginSuccess() {
            // Hide login modal
            document.getElementById('loginModal').style.display = 'none';

            // Update user menu
            document.getElementById('userName').textContent = currentUser.fullName;
            document.getElementById('userRoleDisplay').textContent = currentUser.roleName;
            document.getElementById('userAvatar').textContent = currentUser.initials;
            document.getElementById('userMenu').classList.add('active');

            // Show landing screen
            document.getElementById('landingScreen').classList.add('active');

            // Show welcome message
            setTimeout(() => {
                const welcomeMessages = {
                    'patient': `Welcome ${currentUser.firstName}! You're logged in as a Patient.`,
                    'pharmacist': `Welcome ${currentUser.firstName}! You're logged in as a Verified Pharmacist.`,
                    'doctor': `Welcome Dr. ${currentUser.lastName}! You're logged in as a Medical Doctor.`,
                    'distributor': `Welcome ${currentUser.firstName}! You're logged in as a Medicine Distributor.`,
                    'manufacturer': `Welcome ${currentUser.firstName}! You're logged in as a Medicine Manufacturer.`,
                    'customer': `Welcome ${currentUser.firstName}! You're logged in as a Customer.`  // Added customer
                };

                const message = welcomeMessages[currentUser.role] || `Welcome ${currentUser.firstName}!`;
                alert(message);
            }, 500);
        }

        function handleLogout() {
            // Clear current user
            currentUser = null;
            localStorage.removeItem('medchain_current_user');

            // Hide user menu and content
            document.getElementById('userMenu').classList.remove('active');
            document.getElementById('landingScreen').classList.remove('active');
            document.getElementById('medicineContent').classList.remove('active');
            document.getElementById('controlsBar').classList.remove('active');

            // Clear medicine content
            document.getElementById('medicineContent').innerHTML = '';

            // Show login modal
            document.getElementById('loginModal').style.display = 'flex';
            switchAuthTab('login');

            // Reset login forms
            document.getElementById('loginForm').reset();
            document.getElementById('registerForm').reset();

            // Close any open modals
            closeAIAssistant();
            closeHelp();
            if (document.getElementById('scannerModal').classList.contains('active')) {
                document.getElementById('scannerModal').classList.remove('active');
            }

            // Reset scanned history
            scannedHistory = [];
        }

        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            // Modal triggers
            document.getElementById('aiAssistantBtn').addEventListener('click', showAIAssistant);
            document.getElementById('helpBtn').addEventListener('click', showHelp);
            document.getElementById('startScanBtn').addEventListener('click', showScanner);

            // Modal closers
            document.getElementById('closeAiModal').addEventListener('click', closeAIAssistant);
            document.getElementById('closeHelpModal').addEventListener('click', closeHelp);
            document.getElementById('closeScannerModal').addEventListener('click', closeScanner);

            // Voice button
            document.getElementById('voiceBtn').addEventListener('click', toggleVoice);

            // Close modals on outside click
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });

            // AI input enter key
            document.getElementById('aiInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    sendAIMessage();
                }
            });

            // Camera controls
            document.getElementById('toggleCamera').addEventListener('click', simulateCameraToggle);
            document.getElementById('flashToggle').addEventListener('click', simulateFlashToggle);
            document.getElementById('uploadQR').addEventListener('click', simulateQRUpload);
        }

        // ========== AI ASSISTANT FUNCTIONS ==========
        function showAIAssistant() {
            if (!currentUser) {
                alert('Please login first to use AI Assistant');
                return;
            }
            document.getElementById('aiModal').classList.add('active');
        }

        function closeAIAssistant() {
            document.getElementById('aiModal').classList.remove('active');
        }

        function askAI(question) {
            const input = document.getElementById('aiInput');
            input.value = question;
            sendAIMessage();
        }

        function handleAIKeyPress(event) {
            if (event.key === 'Enter') {
                sendAIMessage();
            }
        }

        function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            if (!message) return;

            // Add user message
            addAIMessage('user', message);
            input.value = '';

            // Generate AI response after delay
            setTimeout(() => {
                generateAIResponse(message);
            }, 1000);
        }

        function addAIMessage(sender, text) {
            const chat = document.getElementById('aiChat');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;

            const senderName = sender === 'ai' ? 'MedChain AI' : currentUser ? currentUser.fullName : 'You';
            messageDiv.innerHTML = `
            <span class="sender">${senderName}:</span>
            <div class="content">${text}</div>
        `;

            chat.appendChild(messageDiv);
            chat.scrollTop = chat.scrollHeight;
        }

        function generateAIResponse(question) {

            const greeting = getGreetingResponse(question);
            if (greeting) {
                return greeting;
            }

            let response = '';
            const lowerQuestion = question.toLowerCase();

            if (lowerQuestion.includes('verified') || lowerQuestion.includes('status')) {
                response = aiKnowledgeBase.verified;
            } else if (lowerQuestion.includes('counterfeit') || lowerQuestion.includes('fake')) {
                response = aiKnowledgeBase.counterfeit;
            } else if (lowerQuestion.includes('blockchain') || lowerQuestion.includes('verification')) {
                response = aiKnowledgeBase.blockchain;
            } else if (lowerQuestion.includes('expired') || lowerQuestion.includes('expiry')) {
                response = aiKnowledgeBase.expired;
            } else if (lowerQuestion.includes('safety') || lowerQuestion.includes('safe')) {
                response = aiKnowledgeBase.safety;
            } else {
                response = `I understand you're asking about: "${question}". As a MedChain AI Assistant, I specialize in medicine safety, blockchain verification, and supply chain transparency. Could you please rephrase or ask about:<br>
             Medicine verification<br>
             Counterfeit detection<br>
             Blockchain technology<br>
             Safety guidelines<br>
             Supply chain tracking?`;
            }

            addAIMessage('ai', response);
        }

        // ========== HELP MODAL FUNCTIONS ==========
        function showHelp() {
            if (!currentUser) {
                alert('Please login first to access help');
                return;
            }
            document.getElementById('helpModal').classList.add('active');
        }

        function closeHelp() {
            document.getElementById('helpModal').classList.remove('active');
        }

        // ========== SCANNER FUNCTIONS ==========
        function showScanner() {
            if (!currentUser) {
                alert('Please login first to use the scanner');
                return;
            }
            document.getElementById('scannerModal').classList.add('active');
        }

        function closeScanner() {
            document.getElementById('scannerModal').classList.remove('active');
        }

        function simulateCameraToggle() {
            alert('Camera toggled (simulated)');
        }

        function simulateFlashToggle() {
            alert('Flash toggled (simulated)');
        }

        function simulateQRUpload() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function (e) {
                alert('QR image uploaded (simulated)');
            };
            input.click();
        }

        // ========== MEDICINE SCANNING FUNCTIONS ==========
        // FIX 10: Modified scanMedicine function with backend API integration
        function scanMedicine(batchId) {
            if (!currentUser) {
                alert('Please login first to scan medicines');
                return;
            }

            currentMedicineData = null;

            // Show loading
            document.getElementById('loadingOverlay').classList.add('active');
            document.getElementById('scannerModal').classList.remove('active');

            // Check for duplicate scan
            if (scannedHistory.includes(batchId)) {
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.remove('active');
                    alert(` This medicine was already scanned earlier.\n\nFirst scanned: ${new Date().toLocaleTimeString()}\n\nPlease scan a different medicine.`);
                }, 1000);
                return;
            }

            // Use backend data (with fallback to local demo data)
            fetch(`http://localhost:3000/api/medicine/${batchId}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        scannedHistory.push(batchId);
                        currentMedicineData = result.data;
                        setTimeout(() => {
                            document.getElementById('loadingOverlay').classList.remove('active');
                            showMedicineResults(currentMedicineData);
                        }, 500);
                    } else {
                        // Fallback to local demo data
                        useLocalDemoData(batchId);
                    }
                })
                .catch(error => {
                    console.log('Using local demo data due to connection error:', error);
                    useLocalDemoData(batchId);
                });
        }

        // FIX 10: Renamed to useLocalDemoData
        function useLocalDemoData(batchId) {
            if (localDemoData[batchId]) {
                scannedHistory.push(batchId);
                currentMedicineData = localDemoData[batchId];
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.remove('active');
                    showMedicineResults(currentMedicineData);
                }, 500);
            } else {
                document.getElementById('loadingOverlay').classList.remove('active');
                // popup removed intentionally
            }
        }

        // ========== MEDICINE DISPLAY FUNCTIONS ==========
        function showMedicineResults(backendData) {
            const transformedData = transformBackendData(backendData);

            // Hide landing, show medicine content
            document.getElementById('landingScreen').classList.remove('active');
            document.getElementById('medicineContent').classList.add('active');
            document.getElementById('controlsBar').classList.add('active');

            // Generate medicine HTML
            document.getElementById('medicineContent').innerHTML = generateMedicineHTML(transformedData);

            // Initialize maps after a short delay
            setTimeout(() => {
                initMaps(transformedData.supplyChain);
                animateTimeline();
            }, 500);

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Speak status
            speakStatus(transformedData.status);
        }

        function transformBackendData(backendData) {
            const medicine = backendData.medicine;
            const supplyChain = backendData.supplyChain || [];
            const verification = backendData.blockchainVerification || {};

            // Determine status class
            let statusClass = 'verified';
            if (medicine.status === 'IN_TRANSIT') statusClass = 'warning';
            if (medicine.status === 'EXPIRED' || medicine.status === 'COUNTERFEIT' || medicine.status === 'RECALLED') statusClass = 'danger';

            // Determine alert
            let alert = false;
            let alertType = '';
            let alertTitle = '';
            let alertMessage = '';

            if (medicine.status === 'COUNTERFEIT') {
                alert = true;
                alertType = 'danger';
                alertTitle = ' Counterfeit Medicine Detected!';
                alertMessage = 'This medicine has been identified as counterfeit. DO NOT USE! The supply chain record shows inconsistencies and possible tampering. Please report this to local health authorities immediately.';
            } else if (medicine.status === 'EXPIRED') {
                alert = true;
                alertType = 'danger';
                alertTitle = ' Expired Medicine!';
                alertMessage = 'This medicine has passed its expiry date. Expired medicines may lose potency or become harmful. DO NOT CONSUME. Properly dispose of at pharmacy collection points.';
            } else if (medicine.status === 'RECALLED') {
                alert = true;
                alertType = 'danger';
                alertTitle = ' Recalled Medicine!';
                alertMessage = 'This batch has been recalled by the manufacturer due to quality concerns. DO NOT USE. Return to pharmacy for proper disposal and refund.';
            } else if (medicine.status === 'IN_TRANSIT') {
                alert = true;
                alertType = 'warning';
                alertTitle = ' Medicine In Transit';
                alertMessage = 'This medicine is currently in transit. Some supply chain steps are incomplete. Verify again when medicine reaches pharmacy.';
            }

            // Get status display text
            let statusText = 'Verified & Safe';
            if (medicine.status === 'IN_TRANSIT') statusText = 'In Transit';
            if (medicine.status === 'EXPIRED') statusText = 'Expired';
            if (medicine.status === 'COUNTERFEIT') statusText = 'Counterfeit';
            if (medicine.status === 'RECALLED') statusText = 'Recalled';

            // Transform medicine data
            const transformedMedicine = {
                batchId: medicine.batch_id,
                name: medicine.name,
                manufacturer: medicine.manufacturer,
                expiryDate: medicine.expiry_date,
                composition: medicine.composition,
                temperatureRange: medicine.temperature_range,
                mfgDate: medicine.mfg_date,
                status: medicine.status,
                statusText: statusText,
                statusClass: statusClass,
                alert: {
                    show: alert,
                    type: alertType,
                    title: alertTitle,
                    message: alertMessage
                }
            };

            // Transform supply chain data
            const transformedSupplyChain = supplyChain.map(step => ({
                step: step.step,
                organization: step.organization,
                timestamp: step.timestamp,
                location: step.location,
                temperature: step.temperature,
                sealStatus: step.seal_status,
                txHash: step.tx_hash,
                coordinates: step.coordinates
            }));

            // Transform blockchain verification
            const transformedVerification = {
                verified: verification.verified,
                status: verification.status,
                txHash: verification.txHash,
                verificationId: verification.verificationId,
                blockNumber: verification.blockNumber,
                timestamp: verification.timestamp,
                recallReason: verification.recall_reason
            };

            return {
                medicine: transformedMedicine,
                supplyChain: transformedSupplyChain,
                verification: transformedVerification,
                status: medicine.status,
                statusClass: statusClass,
                alert: {
                    show: alert,
                    type: alertType,
                    title: alertTitle,
                    message: alertMessage
                }
            };
        }

        // ========== GENERATE MEDICINE HTML ==========
        function generateMedicineHTML(data) {
            const medicine = data.medicine;
            const verification = data.verification;
            const alert = data.alert;

            // Format date
            const formatDate = (dateStr) => {
                if (!dateStr || dateStr === 'Unknown') return 'Not Available';
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            };

            // Get status icon
            const getStatusIcon = () => {
                if (medicine.status === 'VERIFIED') return 'fas fa-check-circle';
                if (medicine.status === 'IN_TRANSIT') return 'fas fa-truck-moving';
                if (medicine.status === 'EXPIRED') return 'fas fa-calendar-times';
                if (medicine.status === 'COUNTERFEIT') return 'fas fa-exclamation-triangle';
                if (medicine.status === 'RECALLED') return 'fas fa-ban';
                return 'fas fa-question-circle';
            };

            return `
            <div class="medicine-card ${medicine.statusClass === 'danger' ? 'counterfeit' : medicine.statusClass === 'warning' ? 'warning' : ''}">
                <div class="medicine-header">
                    <div class="medicine-header-left">
                        <h1 class="medicine-name">${medicine.name}</h1>
                        <div class="medicine-batch">Batch ID: ${medicine.batchId}</div>
                    </div>
                    <div class="status-indicator ${medicine.statusClass}">
                        <i class="${getStatusIcon()}"></i>
                        <span>${medicine.statusText}</span>
                    </div>
                </div>

                <div class="medicine-grid">
                    <div class="info-card">
                        <div class="info-label">
                            <i class="fas fa-industry"></i> Manufacturer
                        </div>
                        <div class="info-value">${medicine.manufacturer}</div>
                    </div>

                    <div class="info-card">
                        <div class="info-label">
                            <i class="fas fa-pills"></i> Composition
                        </div>
                        <div class="info-value">${medicine.composition}</div>
                    </div>

                    <div class="info-card">
                        <div class="info-label">
                            <i class="fas fa-temperature-low"></i> Storage Temperature
                        </div>
                        <div class="info-value">${medicine.temperatureRange}</div>
                    </div>

                    <div class="info-card">
                        <div class="info-label">
                            <i class="fas fa-calendar-alt"></i> Manufacturing Date
                        </div>
                        <div class="info-value">${formatDate(medicine.mfgDate)}</div>
                    </div>

                    <div class="info-card">
                        <div class="info-label">
                            <i class="fas fa-calendar-times"></i> Expiry Date
                        </div>
                        <div class="info-value">${formatDate(medicine.expiryDate)}</div>
                    </div>

                    <div class="info-card">
                        <div class="info-label">
                            <i class="fas fa-shield-alt"></i> Verification Status
                        </div>
                        <div class="info-value ${medicine.statusClass === 'verified' ? 'success' : medicine.statusClass}">
                            <i class="${getStatusIcon()}"></i> ${medicine.statusText}
                        </div>
                    </div>
                </div>

                <!-- Alert Banner -->
                ${alert.show ? `
                <div class="alert-banner ${alert.type}">
                    <div class="alert-header ${alert.type}">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h4>${alert.title}</h4>
                    </div>
                    <div class="alert-content">
                        ${alert.message}
                    </div>
                </div>
                ` : ''}

                <!-- Blockchain Verification -->
                <div class="blockchain-verification">
                    <div class="blockchain-header">
                        <i class="fab fa-ethereum"></i>
                        <h3>Blockchain Verification</h3>
                    </div>
                    <div class="verification-grid">
                        <div class="verification-item">
                            <span class="verification-label">Verification ID</span>
                            <div class="verification-value">${verification.verificationId}</div>
                        </div>
                        <div class="verification-item">
                            <span class="verification-label">Block Number</span>
                            <div class="verification-value">${verification.blockNumber.toLocaleString()}</div>
                        </div>
                        <div class="verification-item">
                            <span class="verification-label">Verification Status</span>
                            <div class="verification-value ${verification.verified ? 'success' : 'danger'}">
                                ${verification.verified ? ' Verified on Blockchain' : ' Not Verified'}
                            </div>
                        </div>
                        <div class="verification-item">
                            <span class="verification-label">Transaction Hash</span>
                            <div class="tx-hash" title="Click to copy">${verification.txHash}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Supply Chain Journey Section -->
            <div class="journey-section">
                <h2 class="section-title">Supply Chain Journey</h2>
                <p class="section-subtitle">
                    Complete blockchain-tracked journey from manufacturer to pharmacy
                </p>

                <div class="timeline-container">
                    <div class="timeline-line"></div>
                    
                    ${data.supplyChain.map((step, index) => `
                    <div class="timeline-step" id="step-${index}">
                        <div class="step-circle ${step.step}">
                            <i class="fas fa-${getStepIcon(step.step)}"></i>
                        </div>
                        <div class="step-content">
                            <div class="step-header">
                                <h3 class="step-title">
                                    <i class="fas fa-${getStepIcon(step.step)}"></i>
                                    ${getStepName(step.step)}
                                </h3>
                                <div class="step-time">${formatDateTime(step.timestamp)}</div>
                            </div>
                            
                            <div class="step-details">
                                <div class="detail-card">
                                    <div class="detail-label">Organization</div>
                                    <div class="detail-value">${step.organization}</div>
                                </div>
                                <div class="detail-card">
                                    <div class="detail-label">Location</div>
                                    <div class="detail-value">${step.location}</div>
                                </div>
                                <div class="detail-card">
                                    <div class="detail-label">Temperature</div>
                                    <div class="detail-value ${isTempSafe(step.temperature, medicine.temperatureRange) ? 'success' : 'danger'}">
                                        ${step.temperature}
                                    </div>
                                </div>
                                <div class="detail-card">
                                    <div class="detail-label">Seal Status</div>
                                    <div class="detail-value ${step.sealStatus === 'INTACT' || step.sealStatus === 'VERIFIED' || step.sealStatus === 'AUTHENTIC' ? 'success' : 'danger'}">
                                        ${step.sealStatus}
                                    </div>
                                </div>
                            </div>

                            ${step.coordinates && step.coordinates !== 'null' ? `
                            <div class="map-container" id="map-${index}">
                                <div class="map-overlay">
                                    <i class="fas fa-map-marker-alt"></i>
                                    ${step.location.split('')[0]}
                                </div>
                            </div>
                            ` : ''}

                            ${step.txHash && step.txHash !== '0x0000000000000000000000000000000000000000000000000000000000000000' && step.txHash !== 'PENDING_TRANSACTION' ? `
                            <div class="tx-hash" title="Blockchain Transaction">
                                <strong>Transaction:</strong> ${step.txHash.substring(0, 20)}...${step.txHash.substring(step.txHash.length - 10)}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    `).join('')}
                </div>
            </div>

            <!-- Blockchain Explainer -->
            <div class="blockchain-explainer">
                <div class="explainer-header">
                    <h2>How Blockchain Ensures Medicine Safety</h2>
                </div>
                
                <div class="explainer-grid">
                    <div class="explainer-card">
                        <div class="explainer-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h3>Immutable Record</h3>
                        <p>Each transaction is permanently recorded on blockchain, preventing tampering or forgery of medicine records.</p>
                    </div>
                    
                    <div class="explainer-card">
                        <div class="explainer-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3>Real-Time Tracking</h3>
                        <p>Track medicine journey in real-time with GPS coordinates and temperature monitoring at each step.</p>
                    </div>
                    
                    <div class="explainer-card">
                        <div class="explainer-icon">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <h3>Patient Safety</h3>
                        <p>Instant verification ensures patients receive authentic, safe, and properly stored medicines.</p>
                    </div>
                </div>
                
                <div class="blockchain-visual">
                    <div class="blockchain-chain">
                        <div class="block"><i class="fas fa-industry"></i>Manufacture</div>
                        <div class="block"><i class="fas fa-truck"></i>Distribute</div>
                        <div class="block"><i class="fas fa-warehouse"></i>Store</div>
                        <div class="block"><i class="fas fa-clinic-medical"></i>Pharmacy</div>
                        <div class="block"><i class="fas fa-user"></i>Patient</div>
                    </div>
                </div>
            </div>

            <!-- Back to Scanner Button -->
            <div class="back-section">
                <button class="back-btn" onclick="showScanner()">
                    <i class="fas fa-qrcode"></i>
                    <span>SCAN ANOTHER MEDICINE</span>
                </button>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p> 2024 MedChain - Blockchain Medicine Verification System</p>
                <div class="footer-badge">
                    <i class="fas fa-shield-alt"></i>
                    <span>Secured by Blockchain Technology</span>
                </div>
            </div>
        `;
        }

        // Helper functions
        // FIX 8: Updated getStepIcon function
        function getStepIcon(step) {
            const icons = {
                manufacturer: 'industry',
                distributor: 'truck',
                wholesaler: 'warehouse',
                pharmacy: 'clinic-medical',
                customer: 'user',
                recall: 'exclamation-triangle'  // Added recall
            };
            return icons[step] || 'map-marker';
        }

        // FIX 8: Updated getStepName function
        function getStepName(step) {
            const names = {
                manufacturer: 'Manufacturing',
                distributor: 'Distribution',
                wholesaler: 'Wholesale Storage',
                pharmacy: 'Pharmacy Dispensing',
                customer: 'Customer Purchase',
                recall: 'Recall Notice'  // Added recall
            };
            return names[step] || step;
        }

        function formatDateTime(datetime) {
            if (!datetime || datetime.includes('Unknown')) return 'Timestamp not available';
            if (datetime.includes('Current')) return 'Live Tracking  Now';
            if (datetime === 'Pending') return 'Pending';

            try {
                const date = new Date(datetime);
                return date.toLocaleString('en-US', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return datetime;
            }
        }

        // FIX 5: Updated isTempSafe function
        function isTempSafe(currentTemp, range) {
            if (!range || !currentTemp || currentTemp === 'Unknown' || currentTemp === '--' || currentTemp === 'Not Monitored') return true;

            try {
                // Extract numbers from temperature strings
                const currentMatch = currentTemp.match(/\d+/);
                if (!currentMatch) return true;

                const current = parseInt(currentMatch[0]);

                // Extract range numbers
                const rangeMatches = range.match(/\d+/g);
                if (!rangeMatches || rangeMatches.length < 2) return true;

                const min = parseInt(rangeMatches[0]);
                const max = parseInt(rangeMatches[1]);

                return current >= min && current <= max;
            } catch (e) {
                console.warn('Temperature check error:', e);
                return true;
            }
        }

        // ========== MAP INITIALIZATION ==========
        // FIX 6: Updated initMaps function with better error handling
        function initMaps(supplyChain) {
            // Clear existing maps
            maps.forEach(map => map.remove());
            maps = [];

            supplyChain.forEach((step, index) => {
                if (step.coordinates && step.coordinates !== 'null' && step.coordinates.includes(',')) {
                    setTimeout(() => {
                        const mapId = `map-${index}`;
                        const mapElement = document.getElementById(mapId);

                        if (mapElement) {
                            try {
                                const coords = step.coordinates.split(',').map(Number);
                                if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                                    const map = L.map(mapId).setView(coords, 12);

                                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                        attribution: ' OpenStreetMap contributors'
                                    }).addTo(map);

                                    L.marker(coords)
                                        .addTo(map)
                                        .bindPopup(`
                                        <strong>${getStepName(step.step)}</strong><br>
                                        ${step.organization}<br>
                                        ${step.location}<br>
                                        <small>${step.timestamp}</small>
                                    `)
                                        .openPopup();

                                    maps.push(map);
                                }
                            } catch (e) {
                                console.warn('Failed to create map:', e);
                            }
                        }
                    }, index * 100);
                }
            });
        }

        function animateTimeline() {
            const steps = document.querySelectorAll('.timeline-step');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, { threshold: 0.1 });

            steps.forEach(step => observer.observe(step));
        }

        // ========== VOICE FUNCTIONS ==========
        function toggleVoice() {
            const voiceBtn = document.getElementById('voiceBtn');

            if (voicePlaying) {
                stopVoice();
                voiceBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                voiceBtn.classList.remove('playing');
                voicePlaying = false;
            } else {
                speakStatus(currentMedicineData.medicine.status);
                voiceBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                voiceBtn.classList.add('playing');
                voicePlaying = true;
            }
        }

        function speakStatus(status) {
            if (!currentMedicineData) return;

            const statusTexts = {
                'VERIFIED': 'Medicine verified. This medicine is authentic and safe to use.',
                'IN_TRANSIT': 'Warning: Medicine in transit. Some supply chain steps are incomplete.',
                'EXPIRED': 'Danger: Medicine expired. Do not consume expired medicine.',
                'COUNTERFEIT': 'Danger: Counterfeit medicine detected. Do not use this medicine.',
                'RECALLED': 'Danger: Recalled medicine. Return to pharmacy immediately.'
            };

            const message = statusTexts[status] || 'Medicine status unknown. Please verify manually.';

            // Use Web Speech API
            if ('speechSynthesis' in window) {
                const speech = new SpeechSynthesisUtterance();
                speech.text = message;
                speech.rate = 1;
                speech.pitch = 1;
                speech.volume = 1;

                // Stop any ongoing speech
                window.speechSynthesis.cancel();

                // Speak the message
                window.speechSynthesis.speak(speech);

                // Update button when speech ends
                speech.onend = function () {
                    const voiceBtn = document.getElementById('voiceBtn');
                    voiceBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                    voiceBtn.classList.remove('playing');
                    voicePlaying = false;
                };
            } else {
                alert('Voice assistant not supported in your browser. Message: ' + message);
            }
        }

        function stopVoice() {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
        }

        // ========== COPY TO CLIPBOARD ==========
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('tx-hash') || e.target.parentElement.classList.contains('tx-hash')) {
                const txHash = e.target.textContent || e.target.parentElement.textContent;
                navigator.clipboard.writeText(txHash).then(() => {
                    alert('Transaction hash copied to clipboard!');
                });
            }
        });

        // ========== ERROR HANDLING ==========
        window.onerror = function (message, source, lineno, colno, error) {
            console.error('Error occurred:', error);
            document.getElementById('loadingOverlay').classList.remove('active');
            alert('An error occurred. Please try again.');
            return true;
        };

        // Prevent navigation away without saving
        window.addEventListener('beforeunload', function (e) {
            if (scannedHistory.length > 0) {
                e.preventDefault();
                e.returnValue = 'You have unsaved scan history. Are you sure you want to leave?';
            }
        });

        // Initialize application
        console.log('MedChain Application Initialized');
        console.log('Version: 1.0.0');
        console.log('Features: Blockchain Verification, AI Assistant, QR Scanning, GPS Tracking');
        console.log('Users Registered:', Object.keys(users).length);

        function getGreetingResponse(message) {
            const msg = message.toLowerCase().trim();

            const greetings = [
                "hi",
                "hello",
                "hey",
                "hai",
                "good morning",
                "good afternoon",
                "good evening"
            ];

            if (greetings.includes(msg)) {
                return "Hello! Im your MedChain AI Assistant. How can I help you with medicine safety or verification today?";
            }

            if (msg.includes("how are you")) {
                return "Im doing well, thank you! Im here to help you with medicine verification, safety checks, and counterfeit detection.";
            }

            if (msg === "thanks" || msg === "thank you") {
                return "Youre welcome! Let me know if you need help with anything related to medicine safety.";
            }

            return null;
        }

    </script>
